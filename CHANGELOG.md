# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- **Contribution Tracking System**: Comprehensive system for recording and analyzing investment contributions over time:
  - New "Registrar Contribuição" tab in Import Data section for recording contributions to existing assets
  - **Cumulative contribution tracking**: Enter only the new contribution amount, system automatically adds it to the current asset value
  - **Automatic position creation**: Creates a new position snapshot with updated values (current value + contribution)
  - **Invested value tracking**: Automatically updates the invested_value field by adding the contribution to previous invested value
  - **Contribution history database**: New `contributions` table tracks every contribution with:
    - Asset name, contribution amount, contribution date
    - Previous value, new total value after contribution
    - Optional notes field (e.g., "Contribuição anual PGBL para IR 2025")
    - Link to created position via foreign key
  - **Contribution History viewer**: New "💰 Contribuições" page in navigation with three analysis tabs:
    - **All Contributions**: Complete list with filters by asset and date range
    - **By Asset**: Grouped view showing total contributions, timeline, and gain/loss calculations per asset
    - **By Period**: Aggregations by month/quarter/year with bar charts and breakdowns
  - **Smart validation**: Prevents recording contributions dated before the last position
  - **Preview interface**: Shows "Previous Value → +Contribution → =New Total" before saving
  - **Category preservation**: Maintains all custom_label and sub_label mappings from previous position
  - **Migration support**: Idempotent migration script for existing databases (`utils/migrate_contributions.py`)
  - **Use cases**: Perfect for tracking annual Previdência contributions for tax purposes, regular savings deposits, or any incremental investments
- **PGBL Tax Planning & Income Tracker**: Comprehensive tax planning tool for maximizing PGBL (Previdência Privada) deductions:
  - New "📊 Planejamento PGBL" tab in Previdência component
  - **Monthly income tracking**: Record all income sources (salary, vacation, bonuses, rental income, etc.) throughout the year
  - **Automatic tax calculation**: System calculates 12% limit based on taxable income (excludes 13th salary and PLR per Brazilian tax law)
  - **Real-time PGBL contribution tracking**: Auto-detects contributions from Previdência positions by year
  - **Smart recommendations**: Shows exactly how much more to invest to maximize tax deduction
  - **Progress visualization**: Progress bar and completion percentage for the 12% limit
  - **Year-over-year planning**: Select any year (past or future) for tax planning
  - **INSS requirement tracking**: Checkbox to confirm INSS contribution (mandatory for PGBL deduction)
  - **Deadline alerts**: Countdown to December 31st deadline with urgency indicators
  - **Income categorization**:
    - Taxable income: Salário, Férias, 1/3 Férias, Pensão, Aluguel, Outro
    - Non-taxable (excluded): 13º Salário, PLR (correct per Brazilian tax code)
  - **Detailed breakdowns**:
    - Summary cards: Taxable income YTD, PGBL limit (12%), invested amount, remaining to invest
    - Monthly breakdown table showing total and taxable income per month
    - Income type summary with taxable status indicators
  - **Annual projection**: Extrapolates full-year income based on months entered
  - **Entry management**: Add, view, and delete income entries with descriptions
  - **Tax benefit estimation**: Calculates potential tax savings from contributions
- **XLSX Import Review & Edit**: Users can now review and edit uploaded XLSX files before saving to the database:
  - New two-stage workflow: Upload → Preview → Edit → Confirm → Save
  - Editable interface showing all parsed positions with current values
  - Modify individual position values with inline number inputs
  - Remove unwanted positions with delete buttons
  - Add new positions that might be missing from the XLSX file
  - Real-time summary showing total positions, value, and changes
  - Visual change indicators (Δ%) for modified values
  - Cancel option to discard all changes and start over
  - Maintains all metadata (date, account, categories) from original file
- **Google Drive Backup & Restore**: Integrated Google Drive API for database backup and restore functionality:
  - OAuth 2.0 authentication flow with credential caching (token.pickle)
  - Manual backup button in sidebar that uploads database with timestamp (format: `investment_data_YYYY-MM-DD_HH-MM-SS.db`)
  - Backup version management: Multiple timestamped backups stored in "AssetFlow Backups" folder
  - Restore functionality with dropdown selection of available backups
  - Automatic safety backup of current database before restore operation
  - Delete backup functionality to manage storage
  - Connection status display and disconnect option
  - Last backup timestamp tracking in session state
  - Comprehensive setup guide (GOOGLE_DRIVE_SETUP.md) with step-by-step OAuth configuration
  - Error handling for authentication failures, network issues, and invalid credentials
- **Emergency Reserve Management for Segurança**: Set a fixed minimum reserve amount for the "Segurança" category. The system automatically calculates excess funds available for rebalancing:
  - Dedicated "🔒 Reserva de Emergência" section in "Classificação de Ativos" tab (separate from target allocations)
  - Simple input to set minimum reserve amount (R$), completely independent from percentage-based targets
  - Automatic calculation of available funds: Current Segurança value - Reserve amount = Available to invest
  - Pre-filled default value in "Valor adicional a investir" input based on calculated excess (uses session_state for proper updates)
  - Smart status indicators in Carteira de Investimento Rebalanceamento tab:
    - ✅ Green success message when Segurança is above minimum (shows excess available)
    - ⚠️ Warning when Segurança is below minimum (shows deficit, sets available to R$ 0)
    - ℹ️ Info message when exactly at reserve amount
  - Segurança completely excluded from target allocation form and validation (not part of 100% calculation)
  - Segurança used ONLY to calculate excess funds for default "Novo Investimento" value
  - Segurança does NOT appear in "Alocação Atual vs Meta" table or rebalancing suggestions
  - Segurança does NOT appear in Carteira de Investimento overview (reserve-only mode, completely separate from portfolio analysis)
- **Default Custom Labels**: "Previdência" (retirement funds) and "Segurança" (safety reserve) custom labels are now automatically created when initializing a new database, ensuring all users start with these essential categories available
- **Edit Existing Positions**: "Atualizar Posições" tab now supports editing positions on the same date to fix incorrect values. New "✏️ Editar na mesma data" checkbox allows users to choose between editing existing data or creating a new snapshot
- **Inline Editing for Invested Values**: Carteira de Investimento "Detalhes por Ativo" tab now allows inline editing of "Investido" (invested_value) column. Click any cell to correct wrong values, and "Ganho" (gain/loss) automatically recalculates. Changes are saved with a single button click
- **Update Positions Feature**: New "Atualizar Posições" tab in the upload component that allows users to:
  - Load positions from a previous date as a starting point
  - Edit individual position values
  - Remove positions that were sold
  - Add new positions that were acquired
  - View real-time summary of changes (total positions, total value, percentage change)
  - Preserve custom labels and classifications when updating
  - Handle duplicate date detection with options to delete or merge
- Session state management for tracking original values to prevent UI updates from affecting displayed original values
- **Asset-Level Rebalancing Details**: Granular breakdown in Carteira de Investimento "Rebalanceamento" tab showing:
  - Individual assets within each category with current values and percentages
  - Specific investment recommendations for each asset when categories are underweight
  - Multiple allocation strategies:
    - **Proportional distribution**: Maintains current asset weights within category
    - **Equal distribution**: Spreads investment equally across all assets in category
    - **Manual selection**: Guidance for custom allocation decisions
  - Smart selling recommendations only when no new investment is provided
  - Warning messages encouraging adding new money instead of selling positions
  - Automatic expansion of categories requiring significant action (>R$ 100 adjustment)
  - Clear visual status indicators (✅ balanced, 🔴 underweight, ⚠️ overweight)

### Fixed
- **Contribution Registration Filter**: Fixed category filter not updating asset list in real-time. Filter is now outside the form, allowing immediate updates when selecting a category instead of waiting for form submission.

### Changed
- **Page Reorganization**: Combined history-related pages for better organization:
  - "💰 Contribuições" page merged into "📈 Histórico" page as a 4th tab
  - Now 3 dashboard pages instead of 4: Carteira, Previdência, Histórico
  - Logical grouping: All historical data (portfolio evolution and contributions) in one place
  - Easier to correlate contributions with portfolio growth over time
- **Contribution Registration UI Improvements**: Added custom_label filter to "Registrar Contribuição" tab for easier asset selection:
  - New "Filtrar por Categoria" dropdown before asset selection
  - Shows only assets from selected category (e.g., "Previdência" shows only PGBL funds)
  - Includes "Todas as Categorias" option to view all assets
  - Significantly improves UX for users with large portfolios (50+ assets)
  - Reduces errors by grouping assets logically
- **Page Rename**: "Importar Dados" → "Gerenciar Posições" to better reflect the page's multi-purpose nature (manual entry, position updates, contribution recording, XLSX uploads)
- **Visualization Improvements**: Replaced bar charts with interactive Plotly donut charts in "Visão Geral" tabs. Donut charts better represent portfolio proportions for rebalancing decisions. Features include:
  - Interactive hover tooltips showing values and percentages
  - Total portfolio value displayed in the center of the donut
  - Clear visual representation of allocation distribution
  - Applied to both Carteira de Investimento and Previdência components
- **Carteira de Investimento Filtering**: Labels with 0% target allocation are now excluded from "Visão Geral" and "Rebalanceamento" tabs, but all assets remain visible in "Detalhes por Ativo" tab. This allows users to have custom labels (like Previdência and Segurança) that don't participate in active portfolio management but can still be tracked
- **Detalhes por Ativo UI**: Filters are now hidden in a collapsible expander (collapsed by default) to reduce visual clutter. Sort dropdown remains visible for easy access
- Upload component now has three tabs: "Entrada Manual", "Upload XLSX", and "Atualizar Posições"
- Carteira de Investimento "Rebalanceamento" tab now includes detailed asset-level breakdown below category-level analysis
- Rebalancing UI now emphasizes adding new money over selling existing positions

### Technical Details
- **Page Reorganization**:
  - Added 4th tab "Contribuições" to history component (components/history.py:32, 43-44)
  - Imported `render_contribution_history` in history.py to embed in new tab (line 10)
  - Removed "💰 Contribuições" from sidebar navigation radio options (main.py:250)
  - Removed contribution_history page route from main() function (previously line 391-392)
  - Removed unused import of render_contribution_history from main.py (previously line 14)
  - Contribution history now accessed via: Histórico page → Contribuições tab
- **UI Improvements for Contribution Registration**:
  - Custom label filtering added to `_render_record_contribution()` function (components/upload.py:396-430)
  - **Critical fix**: Moved category filter OUTSIDE `st.form()` block (line 409) to enable real-time updates
    - Previously: Filter inside form → changes only applied on submit (Streamlit form behavior)
    - Now: Filter outside form → changes trigger immediate rerun and asset list update
  - Extracts unique custom_labels from latest positions, excluding None values
  - Dropdown with "Todas as Categorias" default option plus all custom labels
  - Filters `latest_positions` list based on selected label using list comprehension
  - Asset dropdown populated only with names from filtered positions
  - Preview and validation sections updated to use `filtered_positions` for consistency
  - Empty state handling: shows warning and returns early if no assets in selected category
  - "Dados da Contribuição" header moved outside form for better UX (line 406)
- **Page Renaming**:
  - Navigation label updated from "📁 Importar Dados" to "📁 Gerenciar Posições" (main.py:250)
  - Page routing conditional updated to match new name (main.py:383)
  - Page header updated in upload component (components/upload.py:14)
  - Home page documentation updated with new name and expanded feature list (main.py:297-302, 321, 364)
  - Added bullet points for "Atualize posições existentes" and "Registre contribuições" to home page
- **Contribution Tracking Implementation**:
  - New database table: `contributions` with columns for asset_name, contribution_amount, contribution_date, position_id (FK), previous_value, new_total_value, notes, created_at (database/db.py:123-137)
  - New data model: `Contribution` dataclass with `to_dict()` method (database/models.py:44-69)
  - Database indexes on asset_name, contribution_date, and position_id for efficient querying (database/db.py:149-151)
  - Core database method: `add_contribution()` atomically creates both contribution record and new position (database/db.py:801-881):
    - Finds most recent position for asset via `SELECT * FROM positions WHERE name = ? ORDER BY date DESC LIMIT 1`
    - Validates asset exists (raises ValueError if not found)
    - Calculates new values: `new_total_value = previous_value + contribution_amount`
    - Calculates new invested: `new_invested_value = (previous_invested or previous_value) + contribution_amount`
    - Creates Position with all attributes copied from previous position (category, labels, etc.)
    - Inserts contribution record with reference to new position_id
    - Returns tuple: (contribution_id, position_id)
  - Query methods: `get_contributions_by_asset()`, `get_contributions_between_dates()`, `get_all_contributions()`, `delete_contribution()` (database/db.py:883-929)
  - Helper method: `_row_to_contribution()` converts sqlite3.Row to Contribution object (database/db.py:931-943)
  - New tab in upload component: `_render_record_contribution()` (components/upload.py:384-512):
    - Fetches latest positions with `db.get_latest_positions()`
    - Provides dropdown of all unique asset names sorted alphabetically
    - Form-based input: asset selection, contribution amount, date, optional notes
    - Live preview showing current value, contribution, and new total with percentage change
    - Validates contribution date is not before last position date
    - Displays invested_value calculation if available
  - New component: `components/contribution_history.py` with three rendering functions:
    - `_render_all_contributions()`: Filterable table view with summary metrics
    - `_render_by_asset()`: Expandable asset groups showing timeline and gain/loss
    - `_render_by_period()`: Aggregations by month/quarter/year with bar charts
  - Navigation integration: Added "💰 Contribuições" to sidebar radio options (main.py:250)
  - Page routing: `render_contribution_history(db)` called when "💰 Contribuições" selected (main.py:389-390)
  - Migration script: `utils/migrate_contributions.py` creates contributions table and indexes (idempotent)
  - Session state variable: `contribution_preview` for UI state management (components/upload.py:400-401)
- **PGBL Tax Planning Implementation**:
  - New database tables: `annual_income_entries` and `pgbl_year_settings` (database/db.py:97-132)
  - New data models: `AnnualIncomeEntry` and `PGBLYearSettings` (database/models.py:109-159)
  - `AnnualIncomeEntry` includes `is_taxable` property to determine if income type counts toward PGBL limit
  - Database indexes on year and year+month for efficient querying (database/db.py:130-132)
  - New utility module: `utils/pgbl_tax_calculator.py` with functions:
    - `calculate_taxable_income()`: Filters and sums only taxable income types
    - `calculate_pgbl_limit()`: Returns 12% of taxable income
    - `calculate_remaining_investment()`: Calculates gap to 12% limit
    - `project_annual_income()`: Extrapolates based on months with data
    - `calculate_tax_benefit()`: Estimates tax savings from contributions
    - `get_status_info()`: Returns status, emoji, and color based on completion %
    - `calculate_days_until_deadline()`: Days remaining until Dec 31st
  - Income type constants with Portuguese display names (utils/pgbl_tax_calculator.py:17-28)
  - Database CRUD operations for income entries and year settings (database/db.py:660-778)
  - New tab in Previdência component: `_render_pgbl_planning()` (components/previdencia.py:453-768)
  - Auto-detection of PGBL contributions by filtering positions by year and "Previdência" label
  - Migration script: `utils/migrate_pgbl_tracker.py` for existing databases (idempotent)
  - Year selector with range (current year ± 2) for planning past/future years
  - Form-based income entry with month selector, income type dropdown, amount, and description
  - Real-time aggregations: by month, by income type, taxable vs non-taxable totals
  - Progress bar uses `st.progress()` with capped value (min 0%, max 100%)
  - Status messages dynamically change based on completion: info (0-90%), warning (90-99%), success (100%+)
  - Deadline countdown only shown for current year with conditional styling
- **XLSX Import Review Implementation**:
  - Session state variables for XLSX editing: `xlsx_positions`, `xlsx_metadata`, `xlsx_positions_to_remove`, `xlsx_new_positions`, `xlsx_original_values` (components/upload.py:33-38)
  - Two-stage rendering: `_render_xlsx_upload()` handles upload/preview, `_render_xlsx_editing()` handles editing stage (components/upload.py:28-121)
  - Editable interface with 5-column layout: Asset name, Original value, New value, Change %, Remove button (components/upload.py:156-189)
  - Form-based new position entry matching manual entry workflow (components/upload.py:195-223)
  - Final summary function `_render_xlsx_final_summary_and_save()` handles duplicate detection and save logic (components/upload.py:245-302)
  - State cleanup function `_clear_xlsx_editing_state()` resets all session variables after save/cancel (components/upload.py:305-311)
  - Updated `_import_positions()` to handle optional `percentage` and `quantity` attributes using `hasattr()` (components/upload.py:314-333)
  - Maintains consistency with existing InvestmentPosition model from parser
- **Google Drive Integration**:
  - New utility module: `utils/gdrive_backup.py` with core functions:
    - `authenticate_google_drive()`: Handles OAuth flow and credential caching
    - `upload_backup_to_drive(db_path, credentials)`: Creates timestamped backup in Drive
    - `list_backups_from_drive(credentials)`: Lists all backups sorted by date
    - `download_backup_from_drive(file_id, destination_path, credentials)`: Restores backup
    - `delete_backup_from_drive(file_id, credentials)`: Removes backup from Drive
    - `format_backup_display_name(backup_info)`: Formats timestamps for UI display
  - OAuth scope: `https://www.googleapis.com/auth/drive.file` (minimal permissions)
  - Credentials stored in session state (`st.session_state.gdrive_credentials`)
  - Added dependencies: `google-api-python-client>=2.151.0`, `google-auth-httplib2>=0.2.0`, `google-auth-oauthlib>=1.2.1`
  - New sidebar section in `main.py:render_google_drive_section()` (lines 48-178)
  - Session state variables: `gdrive_credentials`, `last_backup_time`, `confirm_restore`
  - Safety features: Creates local backup with `.before_restore_TIMESTAMP` suffix before restoring
  - Custom exception class: `GoogleDriveBackupError` for proper error handling
  - `.gitignore` updated to exclude `token.pickle` and `credentials.json`
- **Emergency Reserve Implementation**:
  - Separate "Reserva de Emergência" section created before target allocations (components/classification.py:168-201)
  - Independent form for reserve amount with its own submit button (components/classification.py:178-194)
  - Reserve saved with 0% target to exclude from dashboard analysis (components/classification.py:192)
  - Segurança filtered from `all_labels` list using list comprehension (components/classification.py:219)
  - Segurança excluded from existing_targets display (components/classification.py:275-291)
  - Target percentage validation no longer includes Segurança (not part of 100% sum)
  - Position filtering includes labels with `reserve_amount > 0` even if target is 0% (components/dashboard.py:26-29)
  - This ensures Segurança positions are included in calculations despite having 0% target
  - Carteira de Investimento calculates available funds: `excess = current_seguranca - reserve_amount` (components/dashboard.py:231)
  - Three info states tracked: 'excess' (above reserve), 'below' (deficit), 'exact' (at reserve) (components/dashboard.py:233-252)
  - Default investment calculated and stored in `st.session_state.seguranca_excess` (components/dashboard.py:254-262)
  - Session state ensures input value updates when reserve changes (components/dashboard.py:296)
  - Status messages display before "Novo Investimento" section with appropriate styling (components/dashboard.py:265-284)
  - Segurança filtered from target_allocations when reserve_amount is set (components/dashboard.py:208-218)
  - Segurança excluded from comparison table display - only status message shown (components/dashboard.py:319-322)
  - Rebalancing plan calculations don't include Segurança at all (uses filtered target_allocations)
  - Existing `target_allocations.reserve_amount` column in database used (database/db.py:65, database/models.py:60)
- Added `plotly` dependency (version 6.3.1) for interactive visualizations
- Replaced `st.bar_chart` with `plotly.graph_objects.Pie` (hole=0.45) for donut charts
- Donut charts implemented in Carteira de Investimento (components/dashboard.py:129-155) and Previdência (components/previdencia.py:91-117)
- Chart configuration: 45% hole size, outside label positioning, interactive hover templates, center annotations showing total value
- Added `_initialize_default_labels()` method in Database class (database/db.py:110-142)
- Default labels are inserted only if they don't already exist (idempotent operation)
- Labels created with 0% target allocation and no reserve amount (can be customized later)
- Updated dashboard filtering logic to exclude labels with `target_percentage == 0` (components/dashboard.py:24)
- Rebalancing analysis now excludes 0% targets from target_allocations dictionary (components/dashboard.py:183)
- "Detalhes por Ativo" tab now receives `all_positions` to show complete portfolio (components/dashboard.py:94)
- Filters in "Detalhes por Ativo" wrapped in `st.expander()` for cleaner UI (components/dashboard.py:429)
- Added `edit_same_date` session state variable to track edit mode (components/upload.py:213)
- Same-date editing automatically deletes old positions before saving edited ones (components/upload.py:395)
- Dynamic button labels based on edit mode: "Salvar Alterações" for same date, "Salvar Posições Atualizadas" for new date
- Added `update_position_invested_value(position_id, invested_value)` method in Database class (database/db.py:241-252)
- Replaced `st.dataframe` with `st.data_editor` in asset details for inline editing (components/dashboard.py:516-522)
- Only "Investido (R$)" column is editable; all other columns are read-only for data safety
- Change detection compares original vs edited DataFrame to show save button only when needed
- Ganho columns automatically recalculate based on formula: `value - invested_value`
- Added `_render_update_positions()` function to handle the update workflow (components/upload.py:193)
- Added `_save_updated_positions()` helper function for batch saving (components/upload.py:393)
- Added `_clear_editing_state()` helper function for session state cleanup (components/upload.py:411)
- Session state variables added: `editing_positions`, `base_date`, `new_date`, `positions_to_remove`, `new_positions`, `original_values`
- Added `_render_asset_level_rebalancing()` function to display detailed asset recommendations (components/dashboard.py:267)
- Asset recommendations sorted by priority: categories needing action first, then by adjustment amount
- Conditional display logic: selling recommendations only shown when `additional_investment == 0`

## [Previous Versions]

No previous changelog entries exist. This is the first version of the CHANGELOG.
